<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Authorization...</title>
    <style>
        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #000, #1a1a1a);
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
        }
        .loader {
            text-align: center;
        }
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #ff3333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            color: #888;
            font-size: 16px;
        }
        .error {
            color: #ff3333;
        }
        .success {
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p class="status" id="status">Łączenie z Discord...</p>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBIjlu_2muS5ky7hTjsc5E9gV0uOwprX0o",
            authDomain: "fakezone-f3c4a.firebaseapp.com",
            projectId: "fakezone-f3c4a",
            storageBucket: "fakezone-f3c4a.firebasestorage.app",
            messagingSenderId: "795138686378",
            appId: "1:795138686378:web:5e93855a9bf8682f197fd3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const statusEl = document.getElementById('status');

        // Get code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) {
            statusEl.innerHTML = '<span class="error">Anulowano autoryzację</span>';
            setTimeout(() => window.location.href = '/dashboard.html', 2000);
        } else if (!code) {
            statusEl.innerHTML = '<span class="error">Brak kodu autoryzacji</span>';
            setTimeout(() => window.location.href = '/dashboard.html', 2000);
        } else {
            // Wait for auth state
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    statusEl.innerHTML = '<span class="error">Nie jesteś zalogowany</span>';
                    setTimeout(() => window.location.href = '/', 2000);
                    return;
                }

                try {
                    statusEl.textContent = 'Pobieranie danych z Discord...';

                    // Exchange code for user data via our backend
                    const response = await fetch(`https://fakezone-discord-oauth.onrender.com/discord/callback?code=${code}`);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Błąd serwera Discord');
                    }

                    const discordData = await response.json();
                    
                    statusEl.textContent = 'Zapisywanie danych...';

                    // Check if user document exists
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    const discordInfo = {
                        id: discordData.id,
                        username: discordData.username,
                        discriminator: discordData.discriminator || '0',
                        avatar: discordData.avatar,
                        bio: discordData.bio || null
                    };

                    if (userDocSnap.exists()) {
                        // Update existing document
                        await updateDoc(userDocRef, {
                            discord: discordInfo
                        });
                    } else {
                        // Create new document if doesn't exist
                        await setDoc(userDocRef, {
                            username: user.email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/g, ''),
                            displayName: discordData.username,
                            bio: 'Welcome to my zone',
                            avatar: discordData.avatar,
                            discord: discordInfo,
                            links: [],
                            createdAt: new Date().toISOString()
                        });

                        // Also create username mapping
                        const username = user.email.split('@')[0].toLowerCase().replace(/[^a-z0-9_]/g, '');
                        await setDoc(doc(db, 'usernames', username), {
                            uid: user.uid
                        });
                    }

                    statusEl.innerHTML = '<span class="success">✓ Discord połączony!</span>';
                    setTimeout(() => window.location.href = '/dashboard.html', 1500);

                } catch (err) {
                    console.error('Discord OAuth error:', err);
                    statusEl.innerHTML = `<span class="error">Błąd: ${err.message}</span>`;
                    setTimeout(() => window.location.href = '/dashboard.html', 3000);
                }
            });
        }
    </script>
</body>
</html>
