<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Authorization...</title>
    <style>
        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #000, #1a1a1a);
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
        }
        .loader {
            text-align: center;
        }
        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #ff3333;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <p>Connecting to Discord...</p>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBIjlu_2muS5ky7hTjsc5E9gV0uOwprX0o",
            authDomain: "fakezone-f3c4a.firebaseapp.com",
            projectId: "fakezone-f3c4a",
            storageBucket: "fakezone-f3c4a.firebasestorage.app",
            messagingSenderId: "795138686378",
            appId: "1:795138686378:web:5e93855a9bf8682f197fd3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (!code) {
            alert('No authorization code found');
            window.location.href = '/dashboard.html';
        }

        // Exchange code for user data
        (async () => {
            try {
                const response = await fetch(`https://fakezone-discord-oauth.onrender.com/discord/callback?code=${code}`);
                
                if (!response.ok) {
                    throw new Error('Failed to authenticate with Discord');
                }

                const discordData = await response.json();

                // Update user profile in Firestore
                const user = auth.currentUser;
                if (user) {
                    await updateDoc(doc(db, 'users', user.uid), {
                        discord: {
                            id: discordData.id,
                            username: discordData.username,
                            discriminator: discordData.discriminator,
                            avatar: discordData.avatar,
                            bio: discordData.bio
                        },
                        avatar: discordData.avatar, // Auto-set avatar from Discord
                    });

                    alert('âœ“ Discord connected successfully!');
                    window.location.href = '/dashboard.html';
                } else {
                    throw new Error('Not logged in');
                }

            } catch (error) {
                console.error(error);
                alert('Error connecting Discord: ' + error.message);
                window.location.href = '/dashboard.html';
            }
        })();
    </script>
</body>
</html>
